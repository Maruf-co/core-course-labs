# Kube Prometheus Stack

## Describe Components

1. `Grafana` is a visualization tool that displays the collected metrics on dashboards.
2. `Prometheus Operator` is an add-on for Kubernetes and it provides a Kubernetes-based way to deploy Prometheus.
3. `Prometheus` is responsible for collecting metrics from various sources.
4. `Prometheus node-exporter` gathers hardware metrics from nodes in a Kubernetes cluster.
5. `The Prometheus Adapter for Kubernetes Metrics APIs` allows Kubernetes to collect custom metrics from pods and use them in autoscaling decisions.
6. `kube-state-metrics` collects metrics related to Kubernetes objects.
7. `Alertmanager` handles the alerts generated by Prometheus.

## Install Helm Charts

Let's see pods, stateful sets, services, persistent volumes and config maps running command:

```shell
maruf@lenovo~$ kubectl get po,sts,svc,pvc,cm
NAME                                                         READY   STATUS    RESTARTS        AGE
pod/alertmanager-kube-prometheus-kube-prome-alertmanager-0   2/2     Running   1 (6m27s ago)   6m43s
pod/kube-prometheus-grafana-783a5d4e6g-kmm3c                 3/3     Running   0               6m50s
pod/kube-prometheus-kube-prome-operator-c59g03g68-ym67j      1/1     Running   0               6m50s
pod/kube-prometheus-kube-state-metrics-7738hd56e-gr80n       1/1     Running   0               6m50s
pod/kube-prometheus-prometheus-node-exporter-81bbs           1/1     Running   0               6m50s
pod/prometheus-kube-prometheus-kube-prome-prometheus-0       2/2     Running   0               6m50s
pod/helm-app-0                                               1/1     Running   0               46s
pod/helm-app-1                                               1/1     Running   0               46s
pod/helm-app-2                                               1/1     Running   0               46s

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-kube-prometheus-kube-prome-alertmanager   1/1     6m50s
statefulset.apps/prometheus-kube-prometheus-kube-prome-prometheus       1/1     6m50s
statefulset.apps/helm-app                                                3/3     46s

NAME                                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                      ClusterIP   None             <none>        9093/TCP,9094/TCP,9094/UDP   6m43s
service/kube-prometheus-grafana                    ClusterIP   10.77.45.169     <none>        80/TCP                       6m50s
service/kube-prometheus-kube-prome-alertmanager    ClusterIP   10.72.82.112     <none>        9093/TCP                     6m50s
service/kube-prometheus-kube-prome-operator        ClusterIP   10.70.161.201    <none>        443/TCP                      6m50s
service/kube-prometheus-kube-prome-prometheus      ClusterIP   10.72.93.58      <none>        9090/TCP                     6m50s
service/kube-prometheus-kube-state-metrics         ClusterIP   10.70.91.127     <none>        8080/TCP                     6m50s
service/kube-prometheus-prometheus-node-exporter   ClusterIP   10.78.70.2       <none>        9100/TCP                     6m50s
service/kubernetes                                 ClusterIP   10.76.0.2        <none>        443/TCP                      7d
service/prometheus-operated                        ClusterIP   None             <none>        9090/TCP                     6m43s
service/helm-app                                   ClusterIP   10.108.30.77     <none>        80/TCP                       46s

NAME                                                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/persistent-data-volume-helm-app-0   Bound    pvc-5h89812i-704h-3gf8-892e-897hde324g6i   100Mi      RWO            standard       46s
persistentvolumeclaim/persistent-data-volume-helm-app-1   Bound    pvc-h8e72127-1d71-2203-38e3-422i687d2427   100Mi      RWO            standard       46s
persistentvolumeclaim/persistent-data-volume-helm-app-2   Bound    pvc-ih74hi3e-212e-1h87-d626-de4410e15019   100Mi      RWO            standard       46s

NAME                                                                     DATA   AGE
configmap/kube-prometheus-grafana                                        1      6m50s
configmap/kube-prometheus-grafana-config-dashboards                      1      6m50s
configmap/kube-prometheus-kube-prome-alertmanager-overview               1      6m50s
configmap/kube-prometheus-kube-prome-apiserver                           1      6m50s
configmap/kube-prometheus-kube-prome-cluster-total                       1      6m50s
configmap/kube-prometheus-kube-prome-controller-manager                  1      6m50s
configmap/kube-prometheus-kube-prome-etcd                                1      6m50s
configmap/kube-prometheus-kube-prome-grafana-datasource                  1      6m50s
configmap/kube-prometheus-kube-prome-grafana-overview                    1      6m50s
configmap/kube-prometheus-kube-prome-k8s-coredns                         1      6m50s
configmap/kube-prometheus-kube-prome-k8s-resources-cluster               1      6m50s
configmap/kube-prometheus-kube-prome-k8s-resources-namespace             1      6m50s
configmap/kube-prometheus-kube-prome-k8s-resources-node                  1      6m50s
configmap/kube-prometheus-kube-prome-k8s-resources-pod                   1      6m50s
configmap/kube-prometheus-kube-prome-k8s-resources-workload              1      6m50s
configmap/kube-prometheus-kube-prome-k8s-resources-workloads-namespace   1      6m50s
configmap/kube-prometheus-kube-prome-kubelet                             1      6m50s
configmap/kube-prometheus-kube-prome-namespace-by-pod                    1      6m50s
configmap/kube-prometheus-kube-prome-namespace-by-workload               1      6m50s
configmap/kube-prometheus-kube-prome-node-cluster-rsrc-use               1      6m50s
configmap/kube-prometheus-kube-prome-node-rsrc-use                       1      6m50s
configmap/kube-prometheus-kube-prome-nodes                               1      6m50s
configmap/kube-prometheus-kube-prome-nodes-darwin                        1      6m50s
configmap/kube-prometheus-kube-prome-persistentvolumesusage              1      6m50s
configmap/kube-prometheus-kube-prome-pod-total                           1      6m50s
configmap/kube-prometheus-kube-prome-prometheus                          1      6m50s
configmap/kube-prometheus-kube-prome-proxy                               1      6m50s
configmap/kube-prometheus-kube-prome-scheduler                           1      6m50s
configmap/kube-prometheus-kube-prome-workload-total                      1      6m50s
configmap/kube-root-ca.crt                                               1      28d
configmap/prometheus-kube-prometheus-kube-prome-prometheus-rulefiles-0   29     6m43s
configmap/helm-app-config                                                1      46s
```

## Utilize Grafana Dashboards:

a. Check CPU and Memory consumption of your StatefulSet.

![](/k8s/screenshots/lab14/a1.png)
![](/k8s/screenshots/lab14/a2.png)
![](/k8s/screenshots/lab14/a3.png)

Unfortunately, there is no data in Grafana.

b. Identify Pods with higher and lower CPU usage in the default namespace.

![](/k8s/screenshots/lab14/b.png)

And there is no data as well

c. Monitor node memory usage in percentage and megabytes.

![](/k8s/screenshots/lab14/c1.png)
![](/k8s/screenshots/lab14/c2.png)

d. Count the number of pods and containers managed by the Kubelet service.

![](/k8s/screenshots/lab14/d.png)

e. Evaluate network usage of Pods in the default namespace.

![](/k8s/screenshots/lab14/e.png)

Also there is no data.

f. Determine the number of active alerts

![](/k8s/screenshots/lab14/f.png)

## Implement Init Container:

```shell
maruf@lenovo~$ kubectl apply -f https://k8s.io/examples/pods/init-containers.yaml
pod/init-demo created

maruf@lenovo~$ kubectl get pod init-demo
NAME        READY   STATUS            RESTARTS   AGE
init-demo   0/1     PodInitializing   0          32s

maruf@lenovo~$ kubectl get pod init-demo
NAME        READY   STATUS    RESTARTS   AGE
init-demo   1/1     Running   0          43s

maruf@lenovo~$ kubectl exec pod/init-demo -- cat /usr/share/nginx/html/index.html
Defaulted container "nginx" out of: nginx, install (init)
<html><head></head><body><header>
<title>http://info.cern.ch</title>
</header>

<h1>http://info.cern.ch - home of the first website</h1>
<p>From here you can:</p>
<ul>
<li><a href="http://info.cern.ch/hypertext/WWW/TheProject.html">Browse the first website</a></li>
<li><a href="http://line-mode.cern.ch/www/hypertext/WWW/TheProject.html">Browse the first website using the line-mode browser simulator</a></li>
<li><a href="http://home.web.cern.ch/topics/birth-web">Learn about the birth of the web</a></li>
<li><a href="http://home.web.cern.ch/about">Learn about CERN, the physics laboratory where the web was born</a></li>
</ul>
</body></html>
```
